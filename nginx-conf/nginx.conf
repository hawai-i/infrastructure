    
    server {
        listen 80;
        listen [::]:80;
        server_name nginx.rohrstetten.jmj-works.com;
        #server_name rw31jm.selfhost.eu;
        # enforce https
        

        location ^~ /.well-known/acme-challenge/ {
		default_type "text/plain";
		root         /etc/nginx/ssl/acme-challenge;
	}

	### Hide /acme-challenge subdirectory and return 404 on all requests.
	location = /.well-known/acme-challenge/ {
		return 404;
        }

        ### Forward all other requests to https
        location / {
                return 301 https://$server_name$request_uri;
        }
    }
    
    server {
        listen 443 ssl http2;
        listen [::]:443 ssl http2;
        server_name nginx.rohrstetten.jmj-works.com;
        #server_name rw31jm.selfhost.eu;
    
        ssl_certificate           /etc/nginx/ssl/certs/nginx.rohrstetten.jmj-works.com/fullchain.pem;
        ssl_certificate_key       /etc/nginx/ssl/certs/nginx.rohrstetten.jmj-works.com/privkey.pem;
    
    

        location /nextcloud/ {
                #rewrite ^/nextcloud(/.*) $1 break;
                add_header Strict-Transport-Security max-age=31536000; # this is essential for the app to work
                proxy_pass                           http://nextcloud-local:80/;
                proxy_set_header Host               $http_host; 
                proxy_set_header X-Real-IP          $http_host;           
                proxy_set_header X-Forwarded-For    $http_host;     
                proxy_set_header X-Forwarded-Proto  $http_host;          
        }

    }


    server {
        listen       443 ssl;
        server_name  office.rohrstetten.jmj-works.com;
        ssl_certificate           /etc/nginx/ssl/certs/nginx.rohrstetten.jmj-works.com/fullchain.pem;
        ssl_certificate_key       /etc/nginx/ssl/certs/nginx.rohrstetten.jmj-works.com/privkey.pem;
    
        ssl_session_timeout 5m;
        ssl_ciphers               'AES128+EECDH:AES128+EDH:!aNULL:!EDHC';
        ssl_protocols              TLSv1 TLSv1.1 TLSv1.2;
        #ssl_prefer_server_ciphers on;
        #ssl_dhparam /etc/nginx/ssl/dhparam/dhparam.pem;
        #ssl_stapling on;
        #ssl_stapling_verify on;
    
        client_max_body_size 10G;
        
        proxy_set_header     X-Forwarded-Proto 'https';
        underscores_in_headers on;
    
        add_header Strict-Transport-Security max-age=15768000;
        add_header X-Content-Type-Options nosniff;
        add_header X-Frame-Options "SAMEORIGIN";
        add_header X-XSS-Protection "1; mode=block";
        add_header X-Robots-Tag none;
        add_header X-Download-Options noopen;
        add_header X-Permitted-Cross-Domain-Policies none;
    
        access_log  /var/log/nginx/office.access.log;
        error_log   /var/log/nginx/office.error.log;
    
        proxy_buffering off;

        location = /robots.txt {
            allow all;
            log_not_found off;
            access_log off;
        }
    
            # static files
        location ^~ /loleaflet {
            proxy_pass        https://collabora:9980;
            proxy_set_header Host $http_host;
            proxy_ssl_verify              off;
        }
    
        
        # WOPI discovery URL
        location ^~ /hosting/discovery {
            proxy_pass        https://collabora:9980;
            proxy_set_header Host $http_host;
            proxy_ssl_verify              off;
    
     # WebSocket support
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    
      # Main websocket
        location ~ /lool/(.*)/ws$ {
            proxy_pass        https://collabora:9980;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_set_header Host $http_host;
            proxy_read_timeout 36000s;
            proxy_ssl_verify              off;
            # WebSocket support
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
    
        }
    # Admin Console websocket
        location ^~ /lool/adminws {
            proxy_pass        http://collabora:9980;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_set_header Host $http_host;
            proxy_read_timeout 36000s;
            proxy_ssl_verify              off;
            # WebSocket support
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
    
        }
    
        # download, presentation and image upload
        location ^~ /lool {
            proxy_pass        https://collabora:9980;
            proxy_set_header Host $http_host;
            proxy_ssl_verify              off;
            # WebSocket support
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
    
        }
    
        location / {
            proxy_pass        https://collabora:9980;
            proxy_set_header Host $http_host;
            proxy_ssl_verify              off;
    
            # WebSocket support
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

    
    }
